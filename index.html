<!DOCTYPE html>
<html>
    <head>
        <title>NoteToSelf</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">

        <link rel="stylesheet" href="css/index.css">
        
    </head>
    <body>
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <span class="brand" >NoteToSelf</span>

                <ul id="actions" class="nav">
                    <li>
                        <a href="#" id="addNote" title="Add a New Note">
                            <i class="icon-plus"></i><span class="hidden-phone">Add Note</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="saveNotes" title="Save Notes to server-side database">
                            <i class="icon-arrow-up"></i><span class="hidden-phone">Save Notes</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="loadNotes" title="Load notes from server-side database">
                            <i class="icon-arrow-down"></i><span class="hidden-phone">Load Notes</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="clearNotes" title="Clear all notes" onclick="clearNotes();">
                            <i class="icon-trash"></i><span class="hidden-phone">Clear All </span>
                        </a>
                    </li>
                </ul>
                <div id="search" class="navbar-search pull-right">
                    <input type="text" value="" name="search" id="searchNotes" placeholder="" class="search-query" />
                </div>
            </div>
            
        </div>
        <div id="alertzone"></div>
        
        <div id="notesContainer" class="row">
            <pre class="note noteTpl span4"><textarea id="noteText" placeholder="Begin typing your note here"></textarea>
<a class="btn  btn-small btn-primary" onclick="saveText();"><i class="icon-ok"></i> Save</a><a class="btn btn-small " onclick="cancelText();"><i class="icon-remove"></i> Cancel</a></pre>
        </div>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/NoteToSelf.js"></script>
        <script src="js/SearchBar.js"></script>
        <script>
            /**
             * Populate the DOM with notes if already present in storage
             */
            (function populateContainer(){
                var st = NoteToSelf.getStorage();
                for(var i in st)
                {
                    $('.noteTpl').clone()
                                 .prependTo('#notesContainer');
                         
                    $('.noteTpl').first()
                                 .html(st[i])
                                 .prepend('<i class="close icon-remove" data-id="'+i+'"></i>')
                                 .removeClass('noteTpl');
                }
                SearchBar.initialize($("#search input"), '#notesContainer .note:not(.noteTpl)');
            })();
            
            var isEdit = false;
            
            /**
             * Insert new note form
             */
            $("#addNote").click(function(){
                if(isEdit === false)
                {
                    isEdit = true;
                    $('.noteTpl').clone().prependTo('#notesContainer');
                    $('.noteTpl:first-of-type').fadeIn('fast', function(){
                        $(this).removeClass('noteTpl');
                        $("#noteText").focus();
                    });
                }
            });
            
            /**
            * Remove item from storage and DOM
            */
            $('.close').click(function(){
                var noteID = $(this).data('id');
                NoteToSelf.remove(noteID);
                $(this).parent('.note').fadeOut(function(){
                    $(this).remove();
                });
            });
            
            /**
             * Attempt to save notes to MySQL database. Calls userNotes PHP class
             * via ajax, which returns response in JSON
             */
            $("#saveNotes").click(function(){
                $.ajax({
                    type: "POST",
                    url: 'php/user.php',
                    data: {action: "save", notes: NoteToSelf.getStorage()},
                    beforeSend: function(){
                        $('#saveInfo').animate({
                            top: "66%"
                        }, 100, function(){
                            $(this).css({"opacity":1,"top":"100%"});
                        });
                    }
                }).done(function(response){
                    $("#saveInfo").text(response);
                    setTimeout(function(){
                        $("#saveInfo").css({"opacity":0,"top":"-500%"});
                    }, 2500);
                });
            });
            
            /**
            * Attempt to load saved notes from MySQL database 
            */
            $("#loadNotes").click(function(){
                $.ajax({
                    type: "POST",
                    url: 'php/user.php',
                    data: {action: "load", notes: NoteToSelf.getStorage()},
                    beforeSend: function(){
                        $('#loadInfo').animate({
                            top: "66%"
                        }, 1, function(){
                            $(this).css({"opacity":1,"top":"100%"});
                        });
                    }
                }).done(function(response){
                    var jresponse = JSON.parse(response);
                    if(jresponse.error)
                    {
                        $("#loadInfo").text(jresponse.error);
                    }
                    else
                    {
                        $("#loadInfo").text('Sucessfully loaded your notes!');
                        loadFromDB(jresponse.notes);
                    }
                    setTimeout(function(){
                        $("#loadInfo").css({"opacity":0,"top":"-500%"});
                    }, 2500);
                });
            });
            
           /**
            * Remove a note base on its ID
            */
            function removeNote(noteID){
                NoteToSelf.remove(noteID);
                $('span[data-id='+noteID+']').parent('.note').fadeOut(function(){
                    $(this).remove();
                });
            }
            
            /**
             * Attempt to add a note to the container.
             * @param string note
             */
            function saveText(note){
                var note = note || $("#noteText").val();
                var id = NoteToSelf.count();
                if(note !== ''){
                    NoteToSelf.add(note);
                    $('.note').first().html(note);
                    $('.note').first().removeClass('noteTpl').append('<i class="close icon-remove" data-id="' + id  + '" onclick="removeNote('+id+');"></i>');
                    isEdit = false;
                }else
                {
                    alert('Your note is blank!');
                }
            }
            
            /**
             * Cancel 'Add Note'
             */
            function cancelText(){
               $('.note').first().fadeOut('slow', function(){
                   $(this).remove();
               });
               isEdit = false;
            }
            
            /**
             * populate the container using notes from database opposed to local storage
             * @param object notes
             */
            function loadFromDB(notes){
                clearNotes();
                var notes = JSON.parse(notes);
                for(var i in notes)
                {
                    $('.noteTpl').clone().prependTo('#notesContainer');
                    saveText(notes[i]);
                }
            }
            
            /**
             * Reset localStorage and empty the notes container
             */
            function clearNotes(){
                localStorage.setItem('NoteToSelf',JSON.stringify([]));
                $('#notesContainer').children('.note').not('.noteTpl').remove();
            }

        </script>
    </body>
</html>
